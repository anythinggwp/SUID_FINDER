# !/bin/sh

# Параметры
START_DIR=${1:-/}
HOSTNAME_PARAM=$2
OUT_DIR=${3:-$(pwd)}

# Описание файлов

declare -A chrome_sandbox_desc=(
  ["Назначение"]="изолированное выполнение процессов браузера Chrome/Chromium для защиты от атак и уязвимостей."
  ["Штатное использование"]="создание sandbox-окружения для рендеринга веб-контента, обработки медиа и выполнения небезопасного кода."
  ["Риск при компрометации"]="получение выхода из песочницы может дать полный доступ к системе, поскольку sandbox часто имеет SUID root для установки ограничений пространства имён."
)

declare -A su_desc=(
  ["Назначение"]="замена пользователя (вход к учётной записи root или другому пользователю)."
  ["Штатное использование"]="запускается пользователями для переключения на root/других пользователей."
  ["Риск при компрометации"]="злоумышленник может получить привилегии суперпользователя (полный контроль над системой)."
)

declare -A passwd_desc=(
  ["Назначение"]="изменение/управление паролями пользователя."
  ["Штатное использование"]="пользователи и администраторы изменяют пароли."
  ["Риск при компрометации"]="может позволить изменить пароли других пользователей, получить доступ к аккаунтам."
)

declare -A sudo_desc=(
  ["Назначение"]="выполнение команд с привилегиями другого пользователя (обычно root) с логированием."
  ["Штатное использование"]="безопасное выполнение разовых команд с повышенными правами."
  ["Риск при компрометации"]="если sudo неправильно конфигурирован или бинарь заменён — можно выполнить команды от имени root."
)

declare -A mount_desc=(
  ["Назначение"]="подключение/отключение файловых систем."
  ["Штатное использование"]="монтирование внешних носителей, сменных разделов."
  ["Риск при компрометации"]="злоумышленник может монтировать/перемонтировать файловые системы, получить доступ к данным или обойти политики."
)

declare -A umount_desc=(
  ["Назначение"]="отключение файловых систем."
  ["Штатное использование"]="отключение внешних носителей, сменных разделов."
  ["Риск при компрометации"]="злоумышленник может нарушить доступ к данным или обходить политики безопасности."
)

declare -A ping_desc=(
  ["Назначение"]="проверка доступности хостов по сети (ICMP)."
  ["Штатное использование"]="утилита для диагностики сети."
  ["Риск при компрометации"]="исторически SUID для отправки RAW-пакетов; компрометация может дать сетевые права (в прошлом — escalation). Сейчас часто используют capabilities вместо SUID."
)

declare -A exim4_desc=(
  ["Назначение"]="почтовый транспортный агент (MTA) для обработки и доставки электронной почты."
  ["Штатное использование"]="обработка входящей/исходящей почты, управление очередями писем."
  ["Риск при компрометации"]="уязвимости в Exim исторически приводили к удалённому выполнению кода с правами root."
)

declare -A pppd_desc=(
  ["Назначение"]="демон Point-to-Point Protocol для установления PPP-соединений."
  ["Штатное использование"]="подключение модемов, VPN, туннелей PPP."
  ["Риск при компрометации"]="возможность получения контроля над сетевыми интерфейсами или удалённого выполнения кода."
)

declare -A polkit_agent_helper_1_desc=(
  ["Назначение"]="вспомогательный агент polkit для проверки прав пользователя."
  ["Штатное использование"]="обработка запросов аутентификации polkit."
  ["Риск при компрометации"]="может позволить обход политики привилегий или выполнение команд от имени root."
)

declare -A ssh_keysign_desc=(
  ["Назначение"]="утилита OpenSSH для хостовой аутентификации (host-based authentication)."
  ["Штатное использование"]="подписание пакетов ключом хоста от имени ssh-клиента."
  ["Риск при компрометации"]="подмена бинаря может позволить выдавать себя за доверенный хост."
)

declare -A dbus_daemon_launch_helper_desc=(
  ["Назначение"]="вспомогательная программа для запуска системного D-Bus от имени пользователей."
  ["Штатное использование"]="создание частных D-Bus-шин для приложений."
  ["Риск при компрометации"]="возможность перехвата или подмены межпроцессного взаимодействия."
)

declare -A sumac_desc=(
  ["Назначение"]="Утилита для запуска процессов с заданной мандатной меткой."
  ["Штатное использование"]="вспомогательные функции безопасности системы."
  ["Риск при компрометации"]="злоумышленник может запускать процессы с более высоким уровнем доверия, получать доступ к защищённым данным или обходить политики мандатной безопасности."
)

declare -A netkit_rsh_desc=(
  ["Назначение"]="удалённое выполнение команд через rsh-протокол."
  ["Штатное использование"]="наследие старых UNIX-сетей."
  ["Риск при компрометации"]="протокол небезопасен; может привести к удалённому выполнению команд."
)

declare -A netkit_rlogin_desc=(
  ["Назначение"]="удалённый вход в систему через rlogin-протокол."
  ["Штатное использование"]="наследие ранних UNIX-систем."
  ["Риск при компрометации"]="rlogin передаёт данные открытым текстом; может позволить перехват учётных данных."
)

declare -A ntfs_3g_desc=(
  ["Назначение"]="драйвер FUSE для работы с файловыми системами NTFS."
  ["Штатное использование"]="чтение/запись NTFS-разделов."
  ["Риск при компрометации"]="монтаж неподписанных или поддельных разделов, возможный доступ к чувствительным данным."
)

declare -A gpasswd_desc=(
  ["Назначение"]="управление группами пользователей (добавление, удаление, пароли групп)."
  ["Штатное использование"]="администрирование групп."
  ["Риск при компрометации"]="может позволить злоумышленнику изменить групповые привилегии."
)

declare -A pkexec_desc=(
  ["Назначение"]="запуск команд с повышенными привилегиями через polkit."
  ["Штатное использование"]="контролируемое выполнение привилегированных операций GUI-и CLI-приложениями."
  ["Риск при компрометации"]="исторические уязвимости (например, CVE-2021-4034) могли дать root."
)

declare -A fly_wmpam_desc=(
  ["Назначение"]="компонент PAM/аутентификации, специфичный для вашего дистрибутива."
  ["Штатное использование"]="аутентификация пользователей в графической среде."
  ["Риск при компрометации"]="может привести к обходу аутентификации."
)

declare -A fusermount3_desc=(
  ["Назначение"]="управление FUSE-файловыми системами пользователями."
  ["Штатное использование"]="позволяет обычным пользователям монтировать FUSE-разделы."
  ["Риск при компрометации"]="может позволить подменять точки монтирования или вмешиваться в файловую структуру."
)

declare -A netkit_rcp_desc=(
  ["Назначение"]="копирование файлов по сети через rcp-протокол."
  ["Штатное использование"]="старая UNIX-утилита."
  ["Риск при компрометации"]="rcp небезопасен; возможен перехват данных или выполнение произвольных команд."
)

declare -A chfn_desc=(
  ["Назначение"]="изменение информации владельца."
  ["Штатное использование"]="пользователи меняют персональные поля."
  ["Риск при компрометации"]="неправильные права/уязвимости могут позволить изменение учётных данных или обход политик."
)

declare -A chsh_desc=(
  ["Назначение"]="изменение оболочки входа."
  ["Штатное использование"]="пользователи меняют оболочку входа."
  ["Риск при компрометации"]="неправильные права/уязвимости могут позволить обход политик."
)

declare -A newgrp_desc=(
  ["Назначение"]="смена текущей группы процесса."
  ["Штатное использование"]="смена основной группы пользователя для доступа к ресурсам."
  ["Риск при компрометации"]="может дать доступ к файлам другой группы при некорректных настройках."
)

declare -A passwd_system_desc=(
  ["Назначение"]="управление паролями/аутентификацией (вариант system)."
  ["Штатное использование"]="системные процессы управления учётными записями."
  ["Риск при компрометации"]="привилегированный доступ к данным аутентификации."
)

declare -A default_desc=(
  ["Назначение"]="системный бинарный файл (описание по умолчанию не найдено)."
  ["Штатное использование"]="как правило — системный утилитный файл, используемый ОС или администраторами."
  ["Риск при компрометации"]="любой SUID-бинарь при несанкционированном доступе может привести к повышению привилегий, утечке данных или нарушению работы системы."
)

# Проверки утилит
required_cmds="find file hostname"
required_check_sum_utils="md5 cksum"

for cmd in $required_cmds; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Ошибка: требуется команда '$cmd' но она не найдена в PATH." >&2
    exit 2
  fi
done

cntUtils=0

for cmd in $required_check_sum_utils; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    ((cntUtils++))
  fi
done

if (( $cntUtils == 2 )); then
  echo "Ошибка: требуется хотя бы один калькулятор контрольных сумм (md5sum,cksum)." >&2
  exit 2
fi

if [ -z "$HOSTNAME_PARAM" ]; then
  echo "Использование: $0 [START_DIR] HOSTNAME [OUTPUT_DIR]"
  echo "Пример: $0 / my-computer /var/log/suid_reports"
  exit 1
fi

# Проверка каталога для результатов
if [ ! -e "$OUT_DIR" ]; then
  echo "Ошибка: каталог для результатов '$OUT_DIR' не существует." >&2
  exit 3
fi

if [ ! -d "$OUT_DIR" ]; then
  echo "Ошибка: путь '$OUT_DIR' не является каталогом." >&2
  exit 4
fi

# Проверка прав на запись: попробуем создать временный файл
tmpfile="$OUT_DIR/.suid_test_$$"
if ! touch "$tmpfile" >/dev/null 2>&1; then
  echo "Ошибка: нет прав на запись в каталог '$OUT_DIR'." >&2
  exit 5
fi
rm -f "$tmpfile"

# # Формирование имён файлов отчётов
TS=$(date +%Y%m%d_%H%M%S)
LIST_FILE="$OUT_DIR/suid_list_${HOSTNAME_PARAM}_${TS}.txt"
DETAIL_FILE="$OUT_DIR/suid_details_${HOSTNAME_PARAM}_${TS}.txt"

# Запись заголовков в файлы
cat >"$LIST_FILE" <<EOF
SUID список файлов
Имя хоста: $HOSTNAME_PARAM
Стартовый каталог: $START_DIR
Сгенерирован: $(date -u)
EOF

cat >"$DETAIL_FILE" <<EOF
SUID файлы детальный список
Имя хоста: $HOSTNAME_PARAM
Стартовый каталог: $START_DIR
Сгенерирован: $(date -u)
EOF

# # Поиск SUID файлов и формирование отчётов
echo "Запуск поиска SUID-файлов в '$START_DIR'..."
FOUND=0
# find может выдавать сообщение о недоступных каталогах — оставляем в stderr, но не ломаем вывод
find "$START_DIR" -xdev -type f -perm -4000 2>/dev/null | while IFS= read -r fpath; do
  FOUND=1
  # Запишем простую строку в список
  echo "$fpath" >>"$LIST_FILE"

  # Считаем контрольные суммы
  if command -v cksum >/dev/null 2>&1; then
    crc=$(cksum -a crc "$fpath" 2>/dev/null | awk '{print $1}')
    md5=$(cksum -a md5 "$fpath" 2>/dev/null | awk '{print $4}')
    sha1=$(cksum -a sha1 "$fpath" 2>/dev/null | awk '{print $4}')
    sha224=$(cksum -a sha224 "$fpath" 2>/dev/null | awk '{print $4}')
    sha256=$(cksum -a sha256 "$fpath" 2>/dev/null | awk '{print $4}')
    sha512=$(cksum -a sha512 "$fpath" 2>/dev/null | awk '{print $4}')
    blake2b=$(cksum -a blake2b "$fpath" 2>/dev/null | awk '{print $4}')
    sm3=$(cksum -a sm3 "$fpath" 2>/dev/null | awk '{print $4}')
  elif command -v md5sum >/dev/null 2>&1; then
    md5=$(md5sum "$fpath" 2>/dev/null | awk '{print $1}')
  else
    sha1="(cksum отсутствует)"
  fi

  ftyp=$(file -b -- "$fpath" 2>/dev/null)

  fName=$(basename "$fpath")
  descName="${fName}_desc"
  {
    echo "------------------------------------------------------------"
    echo "Файл:                   $fpath"
    echo "CRC:                    $crc"
    echo "MD5:                    $md5"
    echo "SHA1:                   $sha1"
    echo "SHA224:                 $sha224"
    echo "SHA256:                 $sha256"
    echo "SHA512:                 $sha512"
    echo "BLAKE2B:                $blake2b"
    echo "SM3:                    $sm3"
    echo "Тип:                    $ftyp"
    echo "Описание"
  } >>"$DETAIL_FILE"

  # Описание
  if declare -p $descName &>/dev/null; then
    declare -n obj=$descName
    echo "Назначение:             ${obj[Назначение]}" >>"$DETAIL_FILE"
    echo "Штатное использование:  ${obj[Штатное использование]}" >>"$DETAIL_FILE"
    echo "Риск при компрометации: ${obj[Риск при компрометации]}" >>"$DETAIL_FILE"
  else
    echo "Назначение:             ${default_desc[Назначение]}" >>"$DETAIL_FILE"
    echo "Штатное использование:  ${default_desc[Штатное использование]}" >>"$DETAIL_FILE"
    echo "Риск при компрометации: ${default_desc[Риск при компрометации]}" >>"$DETAIL_FILE"
  fi

done

# Если ничего не нашли выводим простыню с ошибкой
if [ ! -s "$LIST_FILE" ] || [ "$(wc -l <"$LIST_FILE")" -le 1 ]; then
  echo "Внимание: не найдено SUID-файлов или у вас нет прав чтения некоторых каталогов." >&2
  echo "Содержимое $LIST_FILE:"
  cat "$LIST_FILE"
else
  echo "Поиск завершён. Результаты записаны в:"
  echo "  - Простая форма: $LIST_FILE"
  echo "  - Подробная форма: $DETAIL_FILE"
fi

exit 0
