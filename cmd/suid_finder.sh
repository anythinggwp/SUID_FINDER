# !/bin/sh

# Описание файлов

declare -A su_desc=(
  ["Назначение"]="замена пользователя (вход к учётной записи root или другому пользователю)."
  ["Штатное использование"]="запускается пользователями для переключения на root/других пользователей."
  ["Риск при компрометации"]="злоумышленник может получить привилегии суперпользователя (полный контроль над системой)."
)

declare -A passwd_desc=(
  ["Назначение"]="изменение/управление паролями пользователя."
  ["Штатное использование"]="пользователи и администраторы изменяют пароли."
  ["Риск при компрометации"]="может позволить изменить пароли других пользователей, получить доступ к аккаунтам."
)

declare -A sudo_desc=(
  ["Назначение"]="выполнение команд с привилегиями другого пользователя (обычно root) с логированием."
  ["Штатное использование"]="безопасное выполнение разовых команд с повышенными правами."
  ["Риск при компрометации"]="если sudo неправильно конфигурирован или бинарь заменён — можно выполнить команды от имени root."
)

declare -A mount_desc=(
  ["Назначение"]="подключение/отключение файловых систем."
  ["Штатное использование"]="монтирование внешних носителей, сменных разделов."
  ["Риск при компрометации"]="злоумышленник может монтировать/перемонтировать файловые системы, получить доступ к данным или обойти политики."
)

declare -A umount_desc=(
  ["Назначение"]="отключение файловых систем."
  ["Штатное использование"]="отключение внешних носителей, сменных разделов."
  ["Риск при компрометации"]="злоумышленник может нарушить доступ к данным или обходить политики безопасности."
)

declare -A ping_desc=(
  ["Назначение"]="проверка доступности хостов по сети (ICMP)."
  ["Штатное использование"]="утилита для диагностики сети."
  ["Риск при компрометации"]="исторически SUID для отправки RAW-пакетов; компрометация может дать сетевые права (в прошлом — escalation). Сейчас часто используют capabilities вместо SUID."
)

declare -A chfn_desc=(
  ["Назначение"]="изменение информации владельца."
  ["Штатное использование"]="пользователи меняют персональные поля."
  ["Риск при компрометации"]="неправильные права/уязвимости могут позволить изменение учётных данных или обход политик."
)

declare -A chsh_desc=(
  ["Назначение"]="изменение оболочки входа."
  ["Штатное использование"]="пользователи меняют оболочку входа."
  ["Риск при компрометации"]="неправильные права/уязвимости могут позволить обход политик."
)

declare -A newgrp_desc=(
  ["Назначение"]="смена текущей группы процесса."
  ["Штатное использование"]="смена основной группы пользователя для доступа к ресурсам."
  ["Риск при компрометации"]="может дать доступ к файлам другой группы при некорректных настройках."
)

declare -A passwd_system_desc=(
  ["Назначение"]="управление паролями/аутентификацией (вариант system)."
  ["Штатное использование"]="системные процессы управления учётными записями."
  ["Риск при компрометации"]="привилегированный доступ к данным аутентификации."
)

declare -A default_desc=(
  ["Назначение"]="системный бинарный файл (описание по умолчанию не найдено)."
  ["Штатное использование"]="как правило — системный утилитный файл, используемый ОС или администраторами."
  ["Риск при компрометации"]="любой SUID-бинарь при несанкционированном доступе может привести к повышению привилегий, утечке данных или нарушению работы системы."
)

suid_objects=(su_desc passwd_desc sudo_desc mount_desc umount_desc ping_desc chfn_desc chsh_desc newgrp_desc passwd_system_desc default_desc)

# Проверки утилит
required_cmds="find md5sum file hostname"
for cmd in $required_cmds; do
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Ошибка: требуется команда '$cmd' но она не найдена в PATH." >&2
    exit 2
  fi
done

# ###############################################################################
# # Параметры
START_DIR=${1:-/}
HOSTNAME_PARAM=$2
OUT_DIR=${3:-$(pwd)}

if [ -z "$HOSTNAME_PARAM" ]; then
  echo "Использование: $0 [START_DIR] HOSTNAME [OUTPUT_DIR]"
  echo "Пример: $0 / my-computer /var/log/suid_reports"
  exit 1
fi

# Проверка каталога для результатов
if [ ! -e "$OUT_DIR" ]; then
  echo "Ошибка: каталог для результатов '$OUT_DIR' не существует." >&2
  exit 3
fi

if [ ! -d "$OUT_DIR" ]; then
  echo "Ошибка: путь '$OUT_DIR' не является каталогом." >&2
  exit 4
fi

# Проверка прав на запись: попробуем создать временный файл
tmpfile="$OUT_DIR/.suid_test_$$"
if ! touch "$tmpfile" >/dev/null 2>&1; then
  echo "Ошибка: нет прав на запись в каталог '$OUT_DIR'." >&2
  exit 5
fi
rm -f "$tmpfile"

# # Формирование имён файлов отчётов
TS=$(date +%Y%m%d_%H%M%S)
LIST_FILE="$OUT_DIR/suid_list_${HOSTNAME_PARAM}_${TS}.txt"
DETAIL_FILE="$OUT_DIR/suid_details_${HOSTNAME_PARAM}_${TS}.txt"

# Запись заголовков в файлы
cat >"$LIST_FILE" <<EOF
SUID files list
Host: $HOSTNAME_PARAM
Search start dir: $START_DIR
Generated: $(date -u)
EOF

cat >"$DETAIL_FILE" <<EOF
SUID files detailed list
Host: $HOSTNAME_PARAM
Search start dir: $START_DIR
Generated: $(date -u)
EOF

# # Поиск SUID файлов и формирование отчётов
# # Используем find с -perm -4000 для SUID (файлы), подавляем stderr к лог-строке
echo "Запуск поиска SUID-файлов в '$START_DIR'..."
FOUND=0
# find может выдавать сообщение о недоступных каталогах — оставляем в stderr, но не ломаем вывод
find "$START_DIR" -xdev -type f -perm -4000 2>/dev/null | while IFS= read -r fpath; do
  FOUND=1
  # Запишем простую строку в список
  echo "$fpath" >>"$LIST_FILE"

  # Соберём md5 и тип файла
  if command -v md5sum >/dev/null 2>&1; then
    md5=$(md5sum "$fpath" 2>/dev/null | awk '{print $1}')
  else
    md5="(md5sum отсутствует)"
  fi

  ftyp=$(file -b -- "$fpath" 2>/dev/null)

  fName=$(basename "$fpath")
  descName="${fName}_desc"
  {
    echo "------------------------------------------------------------"
    echo "File: $fpath"
    echo "MD5:  $md5"
    echo "Type: $ftyp"
    echo "Description:"
  } >>"$DETAIL_FILE"
  # Описание
  if declare -p $descName &>/dev/null; then
    declare -n obj=$descName
    echo "Назначение: ${obj[Назначение]}" >>"$DETAIL_FILE"
    echo "Штатное использование: ${obj[Штатное использование]}" >>"$DETAIL_FILE"
    echo "Риск при компрометации: ${obj[Риск при компрометации]}" >>"$DETAIL_FILE"
  else
    echo "Назначение: ${default_desc[Назначение]}" >>"$DETAIL_FILE"
    echo "Штатное использование: ${default_desc[Штатное использование]}" >>"$DETAIL_FILE"
    echo "Риск при компрометации: ${default_desc[Риск при компрометации]}" >>"$DETAIL_FILE"
  fi

done

# # Если find с while в подшелле не установил FOUND правильно, проверим по файлу LIST_FILE
if [ ! -s "$LIST_FILE" ] || [ "$(wc -l <"$LIST_FILE")" -le 1 ]; then
  echo "Внимание: не найдено SUID-файлов или у вас нет прав чтения некоторых каталогов." >&2
  echo "Содержимое $LIST_FILE:"
  cat "$LIST_FILE"
else
  echo "Поиск завершён. Результаты записаны в:"
  echo "  - Простая форма: $LIST_FILE"
  echo "  - Подробная форма: $DETAIL_FILE"
fi

# exit 0
